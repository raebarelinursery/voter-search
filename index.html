<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raebareli Voter Search</title>
<style>
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    background: #f9f9f9;
    color: #222;
    margin: 0 auto;
    max-width: 1000px;
    padding: 20px;
  }
  h1 { font-size: 20px; margin-bottom: 10px; }
  .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px; }
  input[type="text"] { padding: 8px; width: 280px; }
  button { padding: 8px 12px; cursor: pointer; border: 1px solid #ccc; background: #eee; border-radius: 4px; }
  button:hover { background: #e2e2e2; }
  .stations { max-height: 220px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 8px; width: 300px; }
  .results { flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
  .station-block { border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 8px; }
  .voter { padding: 6px 4px; border-bottom: 1px dashed #f0f0f0; }
  .voter:last-child { border-bottom: none; }
  .top-btn { position: fixed; right: 20px; bottom: 20px; padding: 10px 12px; border-radius: 8px; background: #333; color: #fff; border: none; font-size: 14px; }
  @media (max-width: 600px) {
    .layout { flex-direction: column; }
    .stations, input[type="text"] { width: 100%; }
  }
</style>
</head>
<body>
<h1>Raebareli Voter Search</h1>

<div class="controls">
  <input id="searchInput" type="text" placeholder="Search by name or father/husband name (Hindi or English)">
  <button id="selectAllBtn">Select all</button>
  <button id="clearAllBtn">Clear all</button>
</div>

<div class="layout" style="display:flex; gap:18px; align-items:flex-start;">
  <div>
    <div style="font-weight:600; margin-bottom:6px;">Polling Stations</div>
    <div id="stationsList" class="stations">Loading...</div>
  </div>

  <div class="results" id="results">Loading voter data...</div>
</div>

<button class="top-btn" id="moveTop">Move to Top ↑</button>

<script>
let allData = [];
let stationsIndex = {};
let selectedStations = new Set();

// === Load JSON data ===
fetch('voter_data_final.json')
  .then(r => r.json())
  .then(data => {
    allData = data;
    buildStationList();
    renderResults();
  })
  .catch(err => {
    document.getElementById('stationsList').innerText = '⚠️ Could not load voter_data_final.json';
    document.getElementById('results').innerText = '';
    console.error(err);
  });

// === Build polling-station checkbox list ===
function buildStationList() {
  stationsIndex = {};
  allData.forEach(rec => {
    const st = rec.polling_station || 'unknown';
    stationsIndex[st] = (stationsIndex[st] || 0) + 1;
  });

  const container = document.getElementById('stationsList');
  container.innerHTML = '';
  Object.keys(stationsIndex).sort().forEach(st => {
    const id = 'chk_' + st;
    const div = document.createElement('div');
    div.innerHTML = `<label><input type="checkbox" id="${id}" data-st="${st}"> ${st} <small>(${stationsIndex[st]})</small></label>`;
    container.appendChild(div);

    document.getElementById(id).addEventListener('change', (e) => {
      if (e.target.checked) selectedStations.add(st);
      else selectedStations.delete(st);
      renderResults();
    });
  });
}

document.getElementById('searchInput').addEventListener('input', () => renderResults());
document.getElementById('selectAllBtn').addEventListener('click', () => {
  Object.keys(stationsIndex).forEach(st => selectedStations.add(st));
  document.querySelectorAll('#stationsList input[type=checkbox]').forEach(cb => cb.checked = true);
  renderResults();
});
document.getElementById('clearAllBtn').addEventListener('click', () => {
  selectedStations.clear();
  document.querySelectorAll('#stationsList input[type=checkbox]').forEach(cb => cb.checked = false);
  renderResults();
});

// === English→Hindi transliteration map ===
const translitMap = {
  'a':'अ','aa':'आ','i':'इ','ii':'ई','u':'उ','uu':'ऊ','e':'ए','ai':'ऐ','o':'ओ','au':'औ',
  'k':'क','kh':'ख','g':'ग','gh':'घ','ch':'च','j':'ज','jh':'झ','t':'त','th':'थ','d':'द','dh':'ध','n':'न',
  'p':'प','ph':'फ','b':'ब','bh':'भ','m':'म','y':'य','r':'र','l':'ल','v':'व',
  's':'स','sh':'श','h':'ह','ksh':'क्ष','gy':'ज्ञ'
};

<script>
function transliterate(input) {
  input = input.toLowerCase().trim();

  // --- Normalize common Arabic/Urdu name variants ---
  input = input
    .replace(/mohd|mhd|moh|muh|md\b/g, "muhammad")
    .replace(/muhammad|mohammad|mohamed|muhamad|muhammed|mohmmed/g, "मुहम्मद")
    .replace(/ahmad|ahmed|ahamad|ahmad\b/g, "अहमद")
    .replace(/rehman|rahman/g, "रहमान")
    .replace(/ameen|amin/g, "अमीन")
    .replace(/imran/g, "इमरान")
    .replace(/rehan/g, "रिहान")
    .replace(/faiz/g, "फ़ैज़")
    .replace(/raja/g, "राजा")
    .replace(/naseem|nasim/g, "नसीम")
    .replace(/salman/g, "सलमान");

  // --- Core phonetic transliteration (general Hindi map) ---
  input = input
    .replace(/sh/g, "श")
    .replace(/kh/g, "ख")
    .replace(/gh/g, "घ")
    .replace(/ch/g, "च")
    .replace(/th/g, "थ")
    .replace(/dh/g, "ध")
    .replace(/ph/g, "फ")
    .replace(/bh/g, "भ")
    .replace(/ee/g, "ई")
    .replace(/ii/g, "ई")
    .replace(/oo/g, "ऊ")
    .replace(/ai/g, "ऐ")
    .replace(/au/g, "औ")
    .replace(/in\b/g, "ईन")
    .replace(/een\b/g, "ईन")
    .replace(/an/g, "अन")
    .replace(/am/g, "अम")
    .replace(/a/g, "अ")
    .replace(/i/g, "इ")
    .replace(/e/g, "ए")
    .replace(/u/g, "उ")
    .replace(/o/g, "ओ")
    .replace(/b/g, "ब")
    .replace(/m/g, "म")
    .replace(/n/g, "न")
    .replace(/r/g, "र")
    .replace(/l/g, "ल")
    .replace(/d/g, "द")
    .replace(/t/g, "त")
    .replace(/p/g, "प")
    .replace(/f/g, "फ")
    .replace(/h/g, "ह")
    .replace(/s/g, "स")
    .replace(/k/g, "क")
    .replace(/g/g, "ग")
    .replace(/y/g, "य")
    .replace(/v/g, "व")
    .replace(/j/g, "ज");

  return input;
}
</script>

// === Main render function with bilingual search ===
function renderResults() {
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const qHindi = transliterate(q);
  const results = document.getElementById('results');
  results.innerHTML = '';

  const chosen = Array.from(selectedStations.size ? selectedStations : Object.keys(stationsIndex));
  if (chosen.length === 0) { 
    results.innerHTML = '<i>No polling station selected</i>'; 
    return; 
  }

  chosen.forEach(st => {
    const block = document.createElement('div');
    block.className = 'station-block';
    block.id = 'station_' + st;

    const title = document.createElement('div');
    title.innerHTML = `<strong>${st}</strong> — ${stationsIndex[st]} voters`;
    block.appendChild(title);

    const list = allData.filter(r => {
      if ((r.polling_station || '') !== st) return false;
      if (!q) return true;

      const combined = ((r.name || '') + ' ' + (r.father_or_husband || '')).toLowerCase();
      const combinedHindi = transliterate(combined);

      // --- Enhanced fuzzy bilingual match ---
      return (
        combined.includes(q) ||
        combinedHindi.includes(q) ||
        combined.includes(qHindi) ||
        combinedHindi.includes(qHindi) ||
        combined.startsWith(q) ||
        combinedHindi.startsWith(qHindi)
      );
    });

    if (list.length === 0) {
      const p = document.createElement('div');
      p.style.opacity = 0.7;
      p.innerText = 'No matches';
      block.appendChild(p);
    } else {
      list.forEach(v => {
        const div = document.createElement('div');
        div.className = 'voter';
        div.innerHTML = `<strong>${v.serial || ''}</strong>. ${escapeHtml(v.name || '')} — Father/Husband: ${escapeHtml(v.father_or_husband || '')} ${v.gender ? (' • ' + v.gender) : ''} ${v.age ? (' • Age ' + v.age) : ''} <span style="color:#555;">(Page ${v.pdf_page || ''})</span>`;
        block.appendChild(div);
      });
    }
    results.appendChild(block);
  });
}

// === HTML escape utility ===
function escapeHtml(s) {
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

document.getElementById('moveTop').addEventListener('click', () => {
  document.querySelector('h1').scrollIntoView({behavior:'smooth'});
});
</script>
</body>
</html>
